name: "Spring Boot + Docker Image + Curl (ALL-ECHO, remote Dockerfile)"

on:
  workflow_dispatch:
    inputs:
      java_version:
        description: "JDK ë²„ì „"
        type: choice
        required: true
        default: "21"
        options: ["17", "21"]
      maven_version:
        description: "Maven ë²„ì „ (ì˜ˆ: 3.9.9)"
        required: true
        default: "3.9.9"
      image_name:
        description: "ì´ë¯¸ì§€ ì´ë¦„(íƒœê·¸ ìžë™ ìƒì„±)"
        required: true
        default: "app-image"
      create_release:
        description: "GitHub Release ìƒì„± ì—¬ë¶€"
        type: boolean
        required: true
        default: true
      skip_tests:
        description: "Maven í…ŒìŠ¤íŠ¸ ìƒëžµ"
        type: boolean
        required: true
        default: true
      dockerfile_url:
        description: "Dockerfile RAW URL (ë°˜ë“œì‹œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì •ì‹ ì£¼ì†Œ)"
        required: true
        default: "https://raw.githubusercontent.com/your-org/your-repo/main/Dockerfile"
      dockerfile_use_bearer:
        description: "(ì„ íƒ) Bearer í† í° í—¤ë” ì‚¬ìš© ì—¬ë¶€(ë ˆí¬ ì‹œí¬ë¦¿ DOCKERFILE_TOKEN ì‚¬ìš©)"
        type: boolean
        required: false
        default: false
      dockerfile_extra_curl_flags:
        description: "(ì„ íƒ) ì¶”ê°€ curl í”Œëž˜ê·¸ (ì˜ˆ: --proto '=https' --tlsv1.2)"
        required: false
        default: ""
      dockerfile_sha256:
        description: "(ì„ íƒ) Dockerfile ê¸°ëŒ€ SHA256 (ë¬´ê²°ì„± ê²€ì¦ìš©)"
        required: false
        default: ""

permissions:
  contents: write
  actions: read
  checks: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs

jobs:
  build-package-image:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # í•„ìš” ì‹œ ì„¤ì •í•´ë‘ë©´ Bearerë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤(ìž…ë ¥ dockerfile_use_bearer=trueì¼ ë•Œë§Œ ì ìš©)
      DOCKERFILE_TOKEN: ${{ secrets.DOCKERFILE_TOKEN }}
    defaults:
      run:
        shell: bash
    steps:
      - name: "â˜‘ï¸ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ê³µí†µ: ê° ìŠ¤í…ì— ê²½ëŸ‰ run_cmd ë‚´ìž¥ (ëª¨ë“  ì‹¤í–‰ ì „ echo ì¶œë ¥)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ§­ Env & runner summary"
        run: |
          set -Eeuo pipefail
          mkdir -p "$LOG_DIR"
          export LOG_FILE="$LOG_DIR/01_env_summary.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }
          echo "â–¶ Environment summary" | tee -a "$LOG_FILE"
          run_cmd "uname -a"
          run_cmd "cat /etc/os-release || true"
          run_cmd "docker --version || true"
          run_cmd "which java || true"
          run_cmd "df -h"

      - name: "â˜• Setup Java (Temurin)"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java_version }}

      - name: "â˜• Verify Java"
        run: |
          set -Eeuo pipefail
          export LOG_FILE="$LOG_DIR/02_setup_java.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }
          run_cmd "java -version || true"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Dockerfile: ì›ê²© URLì—ì„œ curl ë‹¤ìš´ë¡œë“œ (+ì˜µì…˜: Bearer/ì¶”ê°€ í”Œëž˜ê·¸/SHA256 ê²€ì¦)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ§¾ Fetch Dockerfile from remote (curl-only)"
        run: |
          set -Eeuo pipefail
          export LOG_FILE="$LOG_DIR/03_dockerfile.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }

          URL="${{ inputs.dockerfile_url }}"
          USE_BEARER="${{ inputs.dockerfile_use_bearer }}"
          EXTRA="${{ inputs.dockerfile_extra_curl_flags }}"
          EXPECT_SHA="${{ inputs.dockerfile_sha256 }}"

          if [ -z "$URL" ]; then
            echo "::error::dockerfile_urlì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤."; exit 1
          fi

          # curl ê¸°ë³¸ ì˜µì…˜(ì—„ê²©/ë””ë²„ê·¸/ìž¬ì‹œë„/íƒ€ìž„ì•„ì›ƒ)
          CURL_BASE="curl -fSsvL --retry 3 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 180"
          [ -n "$EXTRA" ] && CURL_BASE="$CURL_BASE $EXTRA"

          # ì„ íƒ: Bearer í† í° í—¤ë” ì ìš©(ì‹œí¬ë¦¿ì—ì„œ)
          HDRS=""
          if [ "$USE_BEARER" = "true" ]; then
            if [ -n "$DOCKERFILE_TOKEN" ]; then
              HDRS="$HDRS -H \"Authorization: Bearer $DOCKERFILE_TOKEN\""
            else
              echo "::warning::dockerfile_use_bearer=true ì´ì§€ë§Œ DOCKERFILE_TOKEN ì‹œí¬ë¦¿ì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤. í—¤ë” ì—†ì´ ì§„í–‰í•©ë‹ˆë‹¤."
            fi
          fi

          # ë‹¤ìš´ë¡œë“œ
          run_cmd "$CURL_BASE $HDRS \"$URL\" -o Dockerfile"

          # ì¡´ìž¬/ì‚¬ì´ì¦ˆ í™•ì¸
          if [ ! -s Dockerfile ]; then
            echo "::error::Dockerfile ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨(íŒŒì¼ì´ ì—†ê±°ë‚˜ 0ë°”ì´íŠ¸). URL/ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi

          # (ì„ íƒ) SHA256 ë¬´ê²°ì„± ê²€ì¦
          if [ -n "$EXPECT_SHA" ]; then
            echo "â–¶ SHA256 verify" | tee -a "$LOG_FILE"
            ACTUAL_SHA="$(sha256sum Dockerfile | awk '{print $1}')"
            echo "expected=$EXPECT_SHA" | tee -a "$LOG_FILE"
            echo "actual  =$ACTUAL_SHA" | tee -a "$LOG_FILE"
            if [ "$EXPECT_SHA" != "$ACTUAL_SHA" ]; then
              echo "::error::Dockerfile SHA256 ë¶ˆì¼ì¹˜"; exit 1
            fi
          fi

          # ê°„ë‹¨ ë¬¸ë²• ì²´í¬
          if ! head -n 1 Dockerfile | grep -Eq '^FROM[[:space:]]+'; then
            echo "::warning::Dockerfile ì²« ì¤„ì— FROMì´ ì—†ìŠµë‹ˆë‹¤. ì •ìƒ Dockerfileì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
          fi

      - name: "ðŸ§° Install Maven via curl"
        run: |
          set -Eeuo pipefail
          export LOG_FILE="$LOG_DIR/04_maven_install.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }
          MV="${{ inputs.maven_version }}"
          URL="https://archive.apache.org/dist/maven/maven-3/${MV}/binaries/apache-maven-${MV}-bin.tar.gz"
          echo "â–¶ Install Maven ${MV}" | tee -a "$LOG_FILE"
          run_cmd "curl -fsSL \"$URL\" -o maven.tgz"
          run_cmd "sudo tar -C /opt -xzf maven.tgz"
          run_cmd "sudo ln -sf \"/opt/apache-maven-${MV}/bin/mvn\" /usr/local/bin/mvn"
          run_cmd "mvn -v"

      - name: "ðŸ§± Maven Build (package)"
        id: mvn
        run: |
          set -Eeuo pipefail
          export LOG_FILE="$LOG_DIR/05_maven_package.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }
          echo "â–¶ Maven package" | tee -a "$LOG_FILE"
          if [[ "${{ inputs.skip_tests }}" == "true" ]]; then
            run_cmd "mvn -B -DskipTests package"
          else
            run_cmd "mvn -B package"
          fi
          JAR_PATH="$(ls -1 target/*.jar | grep -Ev 'sources|javadoc' | head -n1 || true)"
          if [ -z "$JAR_PATH" ]; then echo "::error::target/ì— ì‹¤í–‰ê°€ëŠ¥ JARì´ ì—†ìŠµë‹ˆë‹¤."; exit 1; fi
          echo "jar_path=$JAR_PATH" >> "$GITHUB_OUTPUT"
          echo "Built JAR: $JAR_PATH" | tee -a "$LOG_FILE"

      - name: "ðŸ³ Build Docker image"
        id: dimg
        run: |
          set -Eeuo pipefail
          export LOG_FILE="$LOG_DIR/06_docker_build.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }
          IMG="${{ inputs.image_name }}"
          TAG="v${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          FULL="${IMG}:${TAG}"
          echo "full_image=$FULL" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "â–¶ Build image: $FULL" | tee -a "$LOG_FILE"
          run_cmd "docker buildx build --load -t \"$FULL\" ."
          run_cmd "docker image ls \"$FULL\""

      - name: "ðŸ“¦ Export image & generate checksums"
        id: saveimg
        run: |
          set -Eeuo pipefail
          export LOG_FILE="$LOG_DIR/07_export.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }
          OUT="dist"
          IMG="${{ steps.dimg.outputs.full_image }}"
          TAR="${OUT}/$(echo "$IMG" | tr '/:' '__').tar"
          TGZ="${TAR}.gz"
          echo "â–¶ Save image & checksums" | tee -a "$LOG_FILE"
          run_cmd "mkdir -p \"$OUT\""
          run_cmd "docker save \"$IMG\" -o \"$TAR\""
          run_cmd "gzip -9 \"$TAR\""
          run_cmd "(cd \"$OUT\" && sha256sum \"$(basename \"$TGZ\")\" > \"$(basename \"$TGZ\").sha256\")"
          run_cmd "(cd \"$OUT\" && md5sum    \"$(basename \"$TGZ\")\" > \"$(basename \"$TGZ\").md5\")"
          JAR="${{ steps.mvn.outputs.jar_path }}"
          run_cmd "cp \"$JAR\" \"$OUT/\""
          run_cmd "(cd \"$OUT\" && sha256sum \"$(basename \"$JAR\")\" > \"$(basename \"$JAR\").sha256\")"
          run_cmd "(cd \"$OUT\" && md5sum    \"$(basename \"$JAR\")\" > \"$(basename \"$JAR\").md5\")"
          echo "tar_gz=$TGZ" >> "$GITHUB_OUTPUT"
          echo "jar_file=$OUT/$(basename "$JAR")" >> "$GITHUB_OUTPUT"

      - name: "â¬†ï¸ Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: springboot-build-and-image
          path: |
            dist/**
            .github/echo_logs/**
          if-no-files-found: error
          retention-days: 14

      - name: "ðŸ·ï¸ Create Release & upload assets"
        if: ${{ inputs.create_release == true }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_id }}-${{ github.run_attempt }}
          name: "Build ${{ github.run_id }}-${{ github.run_attempt }}"
          body: |
            - JDK: ${{ inputs.java_version }}
            - Maven: ${{ inputs.maven_version }}
            - Image: ${{ steps.dimg.outputs.full_image }}
            - Jar: ${{ steps.mvn.outputs.jar_path }}
            - Echo logs included (.github/echo_logs)
          files: |
            dist/*.jar
            dist/*.jar.sha256
            dist/*.jar.md5
            dist/*.tar.gz
            dist/*.tar.gz.sha256
            dist/*.tar.gz.md5

      - name: "ðŸ“¥ Print curl download commands"
        run: |
          set -Eeuo pipefail
          export LOG_FILE="$LOG_DIR/10_curl_examples.log"
          run_cmd(){ local cmd="$*"; printf 'echo %q\n' "$cmd" | tee -a "${LOG_FILE:-/dev/null}"; bash -lc "$cmd" 2>&1 | tee -a "${LOG_FILE:-/dev/null}"; }
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          TAG="v${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          JAR_FILE="$(basename "${{ steps.saveimg.outputs.jar_file }}")"
          IMG_FILE="$(basename "${{ steps.saveimg.outputs.tar_gz }}")"
          echo "â–¶ CURL commands" | tee -a "$LOG_FILE"
          run_cmd "echo curl -L -o ${JAR_FILE} https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/${JAR_FILE}"
          run_cmd "echo curl -L -o ${JAR_FILE}.sha256 https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/${JAR_FILE}.sha256"
          run_cmd "echo sha256sum -c ${JAR_FILE}.sha256"
          run_cmd "echo curl -L -o ${IMG_FILE} https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/${IMG_FILE}"
          run_cmd "echo curl -L -o ${IMG_FILE}.sha256 https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/${IMG_FILE}.sha256"
          run_cmd "echo sha256sum -c ${IMG_FILE}.sha256"
          run_cmd "echo gunzip -c ${IMG_FILE} \| docker load"
