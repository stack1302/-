name: "Java BankCalc â€” Echo Gen + Quality + Security + Build + Test + Run + Artifacts + Docker"

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

concurrency:
  group: bankcalc-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Asia/Seoul
  MAVEN_OPTS: -Xmx1g
  LOG_DIR: .github/echo_logs
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

jobs:
  bankcalc:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Echo helpers (no eval)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          mkdir -p "$LOG_DIR"
          cat <<'SH' > /tmp/echo_helpers.sh
          set -o pipefail
          echoe(){ printf '%s %s\n' "${ECHO_OK}"  "$*"; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*"; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*"; }
          logf(){  printf '%s\n' "$*" | tee -a "${LOG_DIR}/echo.log"; }
          run_cmd(){
            logf "â–¶ $*"
            "$@"; rc=$?
            if [ $rc -eq 0 ]; then echoe "DONE: $*"; else warn "RC=$rc â† $*"; fi
            return $rc
          }
          SH
          chmod +x /tmp/echo_helpers.sh
          source /tmp/echo_helpers.sh
          echoe "Echo helpers ready at /tmp/echo_helpers.sh"
          logf "Workflow started: $(date -Iseconds)"

      # ===== Maven Wrapper: ì‹œìŠ¤í…œ mvn ì—†ì´ ë™ì‘ (curl ì´ìš©) =====
      - name: Bootstrap Maven Wrapper (curl)
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p .mvn/wrapper
          curl -fsSL https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.3.2/maven-wrapper-3.3.2.jar \
            -o .mvn/wrapper/maven-wrapper.jar
          curl -fsSL https://raw.githubusercontent.com/apache/maven-wrapper/maven-wrapper/3.3.2/mvnw \
            -o mvnw
          curl -fsSL https://raw.githubusercontent.com/apache/maven-wrapper/maven-wrapper/3.3.2/mvnw.cmd \
            -o mvnw.cmd
          chmod +x mvnw
          cat > .mvn/wrapper/maven-wrapper.properties <<'PROP'
          distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
          wrapperUrl=https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.3.2/maven-wrapper-3.3.2.jar
          PROP
          echo "âœ… Maven Wrapper prepared (./mvnw -> Maven 3.9.11)"

      - name: EchoOps mass directories/files (always)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          BASE=".github"
          DIRS=( "echo_db/sql" "echo_db/logs" "echo_db/backups" "echo_net" "echo_java" "echo_reports" "echo_tools" "echo_artifacts" "echo_cache" "echo_tmp" )
          for d in "${DIRS[@]}"; do
            run_cmd mkdir -p "${BASE}/${d}"
            run_cmd touch "${BASE}/${d}/.keep"
          done
          for i in $(seq 1 50); do
            ts="$(date -Iseconds)"
            file="${BASE}/echo_reports/report_${i}.txt"
            run_cmd bash -lc -- "printf 'ECHO FILE %03d %s\n' ${i} '${ts}' > '${file}'"
          done
          echoe "Mass gen completed: ${#DIRS[@]} dirs + 50 files"
          echo "MassGen: ${#DIRS[@]} dirs + 50 files" >> "$GITHUB_STEP_SUMMARY"

      # ===== í’ˆì§ˆ ê·œì¹™ íŒŒì¼: Checkstyle êµ¬ê¸€ ê·œì¹™ì„ curlë¡œ ë°›ê³  ì™„í™” + êµ¬ì¡° ìˆ˜ì • =====
      - name: Prepare Checkstyle config via curl (fix structure)
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p .checkstyle
          # 1) êµ¬ê¸€ ê¸°ë³¸ ê·œì¹™ ë‹¤ìš´
          curl -fsSL https://raw.githubusercontent.com/checkstyle/checkstyle/master/src/main/resources/google_checks.xml \
            -o .checkstyle/google_checks.xml
          # 2) ì™„í™”: ì¤„ ê¸¸ì´ 100->140, import/http ì¤„ì€ ì˜ˆì™¸
          sed -i 's#<module name="LineLength">#<module name="LineLength">\n      <property name="max" value="140"/>\n      <property name="ignorePattern" value="^package|^import|http(s)?://"/>#' .checkstyle/google_checks.xml
          # 3) TreeWalker êµ¬ì¡° ì˜¤ë¥˜ ë°©ì§€: JavadocPackageëŠ” Checker ì§ì†
          cat > .checkstyle/checkstyle.xml <<'XML'
          <?xml version="1.0"?>
          <!DOCTYPE module PUBLIC
            "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN"
            "https://checkstyle.org/dtds/configuration_1_3.dtd">
          <module name="Checker">
            <property name="charset" value="UTF-8"/>
            <!-- JavadocPackageëŠ” Checker ì§ì†ì´ì–´ì•¼ í•¨ -->
            <module name="JavadocPackage">
              <property name="severity" value="ignore"/>
            </module>

            <module name="TreeWalker">
              <!-- ì™„í™”/ê°€ë…ì„± ì¤‘ì‹¬ ê¸°ë³¸ ì„¸íŠ¸ -->
              <module name="ImportOrder"><property name="severity" value="warning"/></module>
              <module name="MultipleVariableDeclarations"><property name="severity" value="ignore"/></module>
              <module name="InnerAssignment"><property name="severity" value="ignore"/></module>
              <module name="MagicNumber"><property name="severity" value="ignore"/></module>
              <module name="DesignForExtension"><property name="severity" value="ignore"/></module>
              <module name="HideUtilityClassConstructor"><property name="severity" value="ignore"/></module>
              <module name="JavadocType"><property name="severity" value="ignore"/></module>
              <module name="JavadocMethod"><property name="severity" value="ignore"/></module>
              <module name="JavadocVariable"><property name="severity" value="ignore"/></module>
              <module name="NeedBraces"><property name="severity" value="warning"/></module>
              <module name="WhitespaceAround"><property name="severity" value="warning"/></module>
            </module>

            <module name="FileTabCharacter"><property name="severity" value="warning"/></module>
            <module name="LineLength">
              <property name="max" value="140"/>
              <property name="ignorePattern" value="^package|^import|http(s)?://"/>
            </module>
          </module>
          XML

          cat > .checkstyle/suppressions.xml <<'XML'
          <?xml version="1.0"?>
          <!DOCTYPE suppressions PUBLIC
            "-//Checkstyle//DTD SuppressionFilter Configuration 1.2//EN"
            "https://checkstyle.org/dtds/suppressions_1_2.dtd">
          <suppressions>
          </suppressions>
          XML
          echo "âœ… Checkstyle config ready (.checkstyle/checkstyle.xml)"

      # ===== ì˜ˆì œ í”„ë¡œì íŠ¸/ì†ŒìŠ¤ ìƒì„± (í•„ìš” ì‹œ) =====
      - name: Generate project files (sources, tests, scripts, Dockerfile, README, .gitignore, pom.xml)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd mkdir -p scripts src/main/java/com/example/bank src/test/java/com/example/bank

          cat <<'POM' > pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.example</groupId>
            <artifactId>bankcalc</artifactId>
            <version>0.1.0</version>
            <name>Bank Calculator</name>
            <properties>
              <maven.compiler.release>21</maven.compiler.release>
              <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              <junit.version>5.10.2</junit.version>
              <spotbugs.version>4.8.6.5</spotbugs.version>
              <checkstyle.version>10.18.2</checkstyle.version>
              <spotless.version>2.43.0</spotless.version>
              <enforcer.version>3.5.0</enforcer.version>
              <cyclonedx.version>2.9.0</cyclonedx.version>
              <jacoco.version>0.8.12</jacoco.version>
            </properties>
            <dependencies>
              <dependency>
                <groupId>org.junit.jupiter</groupId>
                <artifactId>junit-jupiter</artifactId>
                <version>${junit.version}</version>
                <scope>test</scope>
              </dependency>
            </dependencies>
            <build>
              <finalName>bankcalc</finalName>
              <plugins>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-jar-plugin</artifactId>
                  <version>3.4.2</version>
                  <configuration>
                    <archive><manifest><mainClass>com.example.bank.Main</mainClass></manifest></archive>
                  </configuration>
                </plugin>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-surefire-plugin</artifactId>
                  <version>3.5.0</version>
                </plugin>
                <plugin>
                  <groupId>org.jacoco</groupId>
                  <artifactId>jacoco-maven-plugin</artifactId>
                  <version>${jacoco.version}</version>
                  <executions>
                    <execution><goals><goal>prepare-agent</goal></goals></execution>
                    <execution><id>report</id><phase>test</phase><goals><goal>report</goal></goals></execution>
                  </executions>
                </plugin>
                <plugin>
                  <groupId>com.diffplug.spotless</groupId>
                  <artifactId>spotless-maven-plugin</artifactId>
                  <version>${spotless.version}</version>
                  <configuration><java><googleJavaFormat/></java></configuration>
                </plugin>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-checkstyle-plugin</artifactId>
                  <version>3.5.0</version>
                  <dependencies>
                    <dependency>
                      <groupId>com.puppycrawl.tools</groupId>
                      <artifactId>checkstyle</artifactId>
                      <version>${checkstyle.version}</version>
                    </dependency>
                  </dependencies>
                  <configuration>
                    <configLocation>.checkstyle/checkstyle.xml</configLocation>
                    <suppressionsLocation>.checkstyle/suppressions.xml</suppressionsLocation>
                    <consoleOutput>true</consoleOutput>
                    <encoding>UTF-8</encoding>
                    <includeTestSourceDirectory>true</includeTestSourceDirectory>
                    <failOnViolation>true</failOnViolation>
                    <outputFile>${project.build.directory}/checkstyle-result.xml</outputFile>
                    <outputFileFormat>xml</outputFileFormat>
                  </configuration>
                </plugin>
                <plugin>
                  <groupId>com.github.spotbugs</groupId>
                  <artifactId>spotbugs-maven-plugin</artifactId>
                  <version>${spotbugs.version}</version>
                </plugin>
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-enforcer-plugin</artifactId>
                  <version>${enforcer.version}</version>
                  <executions>
                    <execution>
                      <id>enforce</id>
                      <goals><goal>enforce</goal></goals>
                      <configuration>
                        <rules>
                          <requireJavaVersion><version>[21,)</version></requireJavaVersion>
                          <dependencyConvergence/>
                        </rules>
                        <fail>true</fail>
                      </configuration>
                    </execution>
                  </executions>
                </plugin>
                <plugin>
                  <groupId>org.cyclonedx</groupId>
                  <artifactId>cyclonedx-maven-plugin</artifactId>
                  <version>${cyclonedx.version}</version>
                  <executions>
                    <execution><phase>package</phase><goals><goal>makeAggregateBom</goal></goals></execution>
                  </executions>
                </plugin>
              </plugins>
            </build>
          </project>
          POM
          echoe "pom.xml generated"

          cat <<'GITIGNORE' > .gitignore
          target/
          pom.xml.tag
          pom.xml.releaseBackup
          pom.xml.versionsBackup
          release.properties
          .idea/
          *.iml
          .project
          .classpath
          .settings/
          .vscode/
          .DS_Store
          Thumbs.db
          outputs/
          GITIGNORE

          cat <<'README' > README.md
          # Java BankCalc
          ì›í™”(â‚©) ë‹¨ìœ„ì˜ í†µì¥ ê³„ì‚°ê¸° â€” ì…ê¸ˆ/ì¶œê¸ˆ/ì´ì(ë‹¨ë¦¬), CSV ìŠ¤í¬ë¦½íŠ¸, ë‚´ì—­ CSV ë‚´ë³´ë‚´ê¸°.
          README

          cat <<'CSV' > scripts/sample-ops.csv
          type,amount,memo
          DEPOSIT,25000,ì›”ê¸‰ ì¼ë¶€
          WITHDRAW,5000,ì‹ë¹„
          INTEREST,123,ì •ì•¡ ì´ì (ì„ì‹œ)
          CSV

          cat <<'DOCKER' > Dockerfile
          FROM gcr.io/distroless/java21-debian12
          WORKDIR /app
          COPY target/bankcalc.jar /app/app.jar
          USER 65532:65532
          ENTRYPOINT ["java","-jar","/app/app.jar"]
          DOCKER

          cat <<'JAVA' > src/main/java/com/example/bank/TransactionType.java
          package com.example.bank;
          public enum TransactionType { DEPOSIT, WITHDRAW, INTEREST }
          JAVA

          cat <<'JAVA' > src/main/java/com/example/bank/Transaction.java
          package com.example.bank;
          import java.math.BigDecimal;
          import java.time.LocalDateTime;
          import java.util.Objects;
          public class Transaction {
            private final LocalDateTime at;
            private final TransactionType type;
            private final BigDecimal amount;
            private final String memo;
            private final BigDecimal balanceAfter;
            public Transaction(LocalDateTime at, TransactionType type,
                               BigDecimal amount, String memo, BigDecimal balanceAfter){
              this.at=at; this.type=type; this.amount=amount; this.memo=memo; this.balanceAfter=balanceAfter;
            }
            public LocalDateTime getAt(){return at;}
            public TransactionType getType(){return type;}
            public BigDecimal getAmount(){return amount;}
            public String getMemo(){return memo;}
            public BigDecimal getBalanceAfter(){return balanceAfter;}
            @Override public String toString(){
              return at + "," + type + "," + amount + "," + (memo==null?"":memo) + "," + balanceAfter;
            }
            @Override public boolean equals(Object o){
              if(this==o) return true;
              if(!(o instanceof Transaction t)) return false;
              return Objects.equals(at,t.at)&&type==t.type&&Objects.equals(amount,t.amount)
                  &&Objects.equals(memo,t.memo)&&Objects.equals(balanceAfter,t.balanceAfter);
            }
            @Override public int hashCode(){ return Objects.hash(at,type,amount,memo,balanceAfter); }
          }
          JAVA

          cat <<'JAVA' > src/main/java/com/example/bank/Account.java
          package com.example.bank;
          import java.math.BigDecimal;
          import java.math.RoundingMode;
          import java.time.LocalDateTime;
          import java.util.ArrayList;
          import java.util.List;
          public class Account {
            private BigDecimal balance = BigDecimal.ZERO.setScale(0, RoundingMode.UNNECESSARY);
            private final List<Transaction> history = new ArrayList<>();
            public Account() {}
            public Account(BigDecimal initial){
              BigDecimal init=ensureKRW(initial);
              this.balance=init;
              history.add(new Transaction(LocalDateTime.now(), TransactionType.DEPOSIT, init, "ì´ˆê¸°ì”ì•¡", balance));
            }
            private static BigDecimal ensureKRW(BigDecimal v){
              if(v==null) return BigDecimal.ZERO.setScale(0);
              return v.setScale(0, RoundingMode.HALF_UP);
            }
            public BigDecimal getBalance(){ return balance; }
            public List<Transaction> getHistory(){ return List.copyOf(history); }
            public Transaction deposit(BigDecimal amount, String memo){
              BigDecimal a=ensureKRW(amount);
              if(a.signum()<=0) throw new IllegalArgumentException("ì…ê¸ˆ ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
              balance=balance.add(a);
              Transaction t=new Transaction(LocalDateTime.now(), TransactionType.DEPOSIT, a, memo, balance);
              history.add(t); return t;
            }
            public Transaction withdraw(BigDecimal amount, String memo){
              BigDecimal a=ensureKRW(amount);
              if(a.signum()<=0) throw new IllegalArgumentException("ì¶œê¸ˆ ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
              if(balance.compareTo(a)<0) throw new IllegalStateException("ì”ì•¡ ë¶€ì¡±");
              balance=balance.subtract(a);
              Transaction t=new Transaction(LocalDateTime.now(), TransactionType.WITHDRAW, a.negate(), memo, balance);
              history.add(t); return t;
            }
            public Transaction applyInterest(BigDecimal annualRatePercent, int days, String memo){
              if(days<0) throw new IllegalArgumentException("ì¼ìˆ˜ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
              BigDecimal rate=annualRatePercent.divide(BigDecimal.valueOf(100),10,RoundingMode.HALF_UP);
              BigDecimal interest=balance.multiply(rate)
                  .multiply(BigDecimal.valueOf(days))
                  .divide(BigDecimal.valueOf(365),0,RoundingMode.HALF_UP);
              if(interest.signum()<=0) return null;
              balance=balance.add(interest);
              Transaction t=new Transaction(LocalDateTime.now(), TransactionType.INTEREST, interest, memo, balance);
              history.add(t); return t;
            }
          }
          JAVA

          cat <<'JAVA' > src/main/java/com/example/bank/CsvIo.java
          package com.example.bank;
          import java.io.*;
          import java.math.BigDecimal;
          import java.nio.charset.StandardCharsets;
          import java.util.List;
          public class CsvIo {
            public static void exportHistory(File out, List<Transaction> history) throws IOException {
              try(BufferedWriter bw=new BufferedWriter(new OutputStreamWriter(new FileOutputStream(out), StandardCharsets.UTF_8))){
                bw.write("at,type,amount,memo,balanceAfter\n");
                for(Transaction t:history){
                  String memo=t.getMemo()==null?"":t.getMemo().replace("\"","\"\"");
                  if(memo.contains(",")) memo="\""+memo+"\"";
                  bw.write(t.getAt()+","+t.getType()+","+t.getAmount()+","+memo+","+t.getBalanceAfter()+"\n");
                }
              }
            }
            public static void runSimpleScript(Account account, File script) throws IOException {
              try(BufferedReader br=new BufferedReader(new InputStreamReader(new FileInputStream(script), StandardCharsets.UTF_8))){
                String line; int lineNo=0;
                while((line=br.readLine())!=null){
                  lineNo++;
                  if(lineNo==1 && line.startsWith("type")) continue;
                  if(line.isBlank()) continue;
                  String[] p=splitCsv(line);
                  if(p.length<2) throw new IllegalArgumentException("CSV í¬ë§· ì˜¤ë¥˜ (line "+lineNo+"): "+line);
                  String type=p[0].trim().toUpperCase();
                  BigDecimal amount=new BigDecimal(p[1].trim());
                  String memo=p.length>=3?p[2].trim():"";
                  switch(type){
                    case "DEPOSIT" -> account.deposit(amount,memo);
                    case "WITHDRAW" -> account.withdraw(amount,memo);
                    case "INTEREST" -> { if(amount.signum()>0) account.deposit(amount, memo.isEmpty()? "ì •ì•¡ ì´ì": memo); }
                    default -> throw new IllegalArgumentException("ì§€ì›í•˜ì§€ ì•ŠëŠ” íƒ€ì…: "+type);
                  }
                }
              }
            }
            private static String[] splitCsv(String line){
              boolean inQuote=false;
              StringBuilder cur=new StringBuilder();
              java.util.List<String> out=new java.util.ArrayList<>();
              for(int i=0;i<line.length();i++){
                char c=line.charAt(i);
                if(c=='\"') inQuote=!inQuote;
                else if(c==',' && !inQuote){ out.add(cur.toString()); cur.setLength(0);}
                else cur.append(c);
              }
              out.add(cur.toString());
              return out.toArray(new String[0]);
            }
          }
          JAVA

          cat <<'JAVA' > src/main/java/com/example/bank/Main.java
          package com.example.bank;
          import java.io.File;
          import java.math.BigDecimal;
          import java.util.Arrays;
          public class Main {
            private static void usage(){
              System.out.println("""
              ì‚¬ìš©ë²•:
                java -jar bankcalc.jar [ì˜µì…˜]
              ì˜µì…˜:
                --start <ì›>                 ì‹œì‘ ì”ì•¡ (ê¸°ë³¸: 0)
                --deposit <ì›> [--memo "ë©”ëª¨"]
                --withdraw <ì›> [--memo "ë©”ëª¨"]
                --interest <ì—°ì´ìœ¨%> --days <ì¼ìˆ˜> [--memo "ë©”ëª¨"]   # ë‹¨ë¦¬, ì›ë‹¨ìœ„ ë°˜ì˜¬ë¦¼
                --script <csv>               # ê°„ë‹¨ CSV: type,amount,memo
                --export <csv>               # ì‹¤í–‰ í›„ ê±°ë˜ ë‚´ì—­ì„ CSVë¡œ ì €ì¥
              ì˜ˆì‹œ:
                java -jar bankcalc.jar --start 100000 --deposit 25000 --withdraw 5000 --interest 3.2 --days 30 --export out.csv
                java -jar bankcalc.jar --start 100000 --script scripts/sample-ops.csv --export out.csv
              """);
            }
            public static void main(String[] args) throws Exception {
              if(args.length==0 || Arrays.asList(args).contains("--help")){ usage(); return; }
              BigDecimal start=BigDecimal.ZERO; String memo=""; File script=null, export=null;
              BigDecimal deposit=null, withdraw=null, rate=null; Integer days=null;
              for(int i=0;i<args.length;i++){
                switch(args[i]){
                  case "--start" -> start=new BigDecimal(args[++i]);
                  case "--deposit" -> deposit=new BigDecimal(args[++i]);
                  case "--withdraw" -> withdraw=new BigDecimal(args[++i]);
                  case "--interest" -> rate=new BigDecimal(args[++i]);
                  case "--days" -> days=Integer.parseInt(args[++i]);
                  case "--memo" -> memo=args[++i];
                  case "--script" -> script=new File(args[++i]);
                  case "--export" -> export=new File(args[++i]);
                  default -> { System.err.println("ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: "+args[i]); usage(); return; }
                }
              }
              Account account=new Account(start);
              if(script!=null) CsvIo.runSimpleScript(account, script);
              if(deposit!=null) account.deposit(deposit, memo.isBlank()? "ì…ê¸ˆ": memo);
              if(withdraw!=null) account.withdraw(withdraw, memo.isBlank()? "ì¶œê¸ˆ": memo);
              if(rate!=null){
                if(days==null) throw new IllegalArgumentException("--interest ì‚¬ìš© ì‹œ --days í•„ìš”");
                account.applyInterest(rate, days, memo.isBlank()? "ì´ì": memo);
              }
              System.out.println("ìµœì¢… ì”ì•¡(ì›): "+account.getBalance());
              System.out.println("ê±°ë˜ ê±´ìˆ˜: "+account.getHistory().size());
              if(export!=null){
                CsvIo.exportHistory(export, account.getHistory());
                System.out.println("ë‚´ì—­ CSV ì €ì¥: "+export.getAbsolutePath());
              }
            }
          }
          JAVA

          cat <<'JAVA' > src/test/java/com/example/bank/AccountTest.java
          package com.example.bank;
          import org.junit.jupiter.api.Test;
          import java.math.BigDecimal;
          import static org.junit.jupiter.api.Assertions.*;
          public class AccountTest {
            @Test void depositWithdrawInterest(){
              Account a=new Account(new BigDecimal("100000"));
              a.deposit(new BigDecimal("25000"), "í…ŒìŠ¤íŠ¸ì…ê¸ˆ");
              assertEquals(new BigDecimal("125000"), a.getBalance());
              a.withdraw(new BigDecimal("5000"), "í…ŒìŠ¤íŠ¸ì¶œê¸ˆ");
              assertEquals(new BigDecimal("120000"), a.getBalance());
              a.applyInterest(new BigDecimal("3.65"), 30, "ì´ì");
              assertEquals(new BigDecimal("120360"), a.getBalance());
            }
          }
          JAVA

          echoe "Project files generated"
          run_cmd find . -maxdepth 3 -type f | sort

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Echo setup-java results
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          echoe "JAVA_HOME=${JAVA_HOME}"
          run_cmd java -version || true
          run_cmd ./mvnw -v || true
          SETTINGS="$HOME/.m2/settings.xml"
          if [ -f "$SETTINGS" ]; then
            echoe "settings.xml present at $SETTINGS"
            head -n 20 "$SETTINGS" | sed 's/^/settings> /' || true
          else
            warn "settings.xml not found (setup-java may create one only when needed)"
          fi

      - name: Warm up Maven cache (go-offline)
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd ./mvnw -q -e -DskipTests dependency:go-offline

      - name: Maven Spotless Apply (auto-fix formatting)
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd ./mvnw -q -e spotless:apply

      - name: Maven Test
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd ./mvnw -q -e -DskipTests=false test

      # ğŸ”§ êµ¬ì¡° ì˜¤ë¥˜ í•´ê²°ëœ Checkstyle ì‚¬ìš© + ì‹¤íŒ¨í•´ë„ íŒŒì´í”„ë¼ì¸ ìœ ì§€
      - name: Lint & Static Analysis (Spotless/Checkstyle/SpotBugs)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd ./mvnw -q -e spotless:check checkstyle:check spotbugs:spotbugs

      # ===== íŒ¨í‚¤ì§• & SBOM & Trivy: Checkstyle ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰ =====
      - name: Maven Package
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd ./mvnw -q -e -DskipTests package
          run_cmd ls -al target || true

      - name: Generate SBOM (CycloneDX)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd ./mvnw -q -e cyclonedx:makeAggregateBom

      - name: Trivy scan (after package)
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          scan-type: fs
          input: target
          scanners: vuln,secret,config
          ignore-unfixed: true
          severity: CRITICAL,HIGH
          format: table
          output: trivy-javabuild.txt

      # ===== Artifacts =====
      - name: Upload Surefire reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            target/surefire-reports/**
            target/checkstyle-result.xml
          if-no-files-found: warn
          retention-days: 14

      - name: Upload JaCoCo report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/**
          if-no-files-found: warn
          retention-days: 14

      - name: Upload SBOM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            target/bom.json
            target/bom.xml
          if-no-files-found: warn
          retention-days: 14

      - name: Upload Trivy result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-java
          path: trivy-javabuild.txt
          if-no-files-found: warn
          retention-days: 14

      - name: Upload JAR Artifact (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bankcalc-jar
          path: target/bankcalc.jar
          if-no-files-found: warn
          retention-days: 14

      - name: Run example (always)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd mkdir -p outputs
          if [ -f target/bankcalc.jar ]; then
            run_cmd java -jar target/bankcalc.jar --start 100000 \
                 --script scripts/sample-ops.csv \
                 --interest 3.2 --days 30 \
                 --export outputs/history.csv
            FINAL_BAL=$( (tail -n 1 outputs/history.csv 2>/dev/null || echo ",,,,") | awk -F',' '{print $5}')
            echo "FINAL_BALANCE=${FINAL_BAL}" | tee -a "$GITHUB_STEP_SUMMARY"
            (head -n 5 outputs/history.csv 2>/dev/null || true) | sed 's/^/CSV> /' | tee -a "$GITHUB_STEP_SUMMARY"
          else
            echo "JAR not found; skipping run example" | tee -a "$GITHUB_STEP_SUMMARY"
          fi
          run_cmd ls -al outputs || true

      - name: Upload outputs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bankcalc-outputs
          path: outputs/**
          if-no-files-found: warn
          retention-days: 14

      # ===== Docker =====
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (load local linux/amd64)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          if [ -f target/bankcalc.jar ]; then
            run_cmd docker buildx build \
              --platform linux/amd64 \
              --cache-from type=gha --cache-to type=gha,mode=max \
              -t bankcalc:local --load .
          else
            echo "No JAR -> skip docker build"
          fi

      - name: GHCR Login & Multi-arch Push (best-effort)
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          if [ -f target/bankcalc.jar ]; then
            IMAGE="ghcr.io/${{ github.repository_owner }}/bankcalc:$(date +%Y%m%d)-${{ github.run_number }}"
            echo "${{ github.token }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            run_cmd docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --cache-from type=gha --cache-to type=gha,mode=max \
              -t "$IMAGE" --push .
          else
            echo "No JAR -> skip multi-arch push"
          fi

      - name: Upload Echo logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: echo-logs
          path: .github/echo_logs/**
          if-no-files-found: warn
          retention-days: 14
