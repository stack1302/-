name: "ğŸ—‚ï¸ Mass Directory Creator"

on:
  workflow_dispatch:
    inputs:
      root_dir:
        description: "ìƒì„± ê¸°ì¤€ ê²½ë¡œ(ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ ê¸°ì¤€)"
        required: true
        default: ".github/echo_mass"
      top_count:
        description: "ìµœìƒìœ„ ë””ë ‰í† ë¦¬ ê°œìˆ˜ (ì˜ˆ: 1000)"
        required: true
        default: "1000"
      sub_count:
        description: "ê° ìµœìƒìœ„ ë””ë ‰í† ë¦¬ ì•„ë˜ í•˜ìœ„ ë””ë ‰í† ë¦¬ ê°œìˆ˜ (0=ì—†ìŒ)"
        required: true
        default: "5"
      prefix:
        description: "ë””ë ‰í† ë¦¬ ì ‘ë‘ì–´ (ì˜ˆ: dir-)"
        required: true
        default: "dir-"
      sub_prefix:
        description: "í•˜ìœ„ ë””ë ‰í† ë¦¬ ì ‘ë‘ì–´ (ì˜ˆ: sub-)"
        required: true
        default: "sub-"
      add_placeholder_files:
        description: ".keep/README.md ë“± í”Œë ˆì´ìŠ¤í™€ë” íŒŒì¼ ìƒì„± ì—¬ë¶€ (true/false)"
        required: true
        default: "true"
      commit_changes:
        description: "ë³€ê²½ì‚¬í•­ ì»¤ë°‹/í‘¸ì‹œ ì—¬ë¶€ (true/false)"
        required: true
        default: "false"
      commit_message:
        description: "ì»¤ë°‹ ë©”ì‹œì§€ (commit_changes=trueì¼ ë•Œ ì‚¬ìš©)"
        required: false
        default: "chore(mass-dir): add generated directories"
      artifact_name:
        description: "ì•„í‹°íŒ©íŠ¸ ì´ë¦„"
        required: true
        default: "mass-dir-listing"

permissions:
  contents: write  # ì»¤ë°‹/í‘¸ì‹œ ì˜µì…˜ì„ ìœ„í•´ í•„ìš”

concurrency:
  group: mass-dir-${{ github.ref }}
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      ROOT_DIR: ${{ inputs.root_dir }}
      TOP: ${{ inputs.top_count }}
      SUB: ${{ inputs.sub_count }}
      PREF: ${{ inputs.prefix }}
      SUBP: ${{ inputs.sub_prefix }}
      ADD_FILES: ${{ inputs.add_placeholder_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate inputs & safety guard
        shell: bash
        run: |
          set -Eeuo pipefail
          # ìˆ«ì ê²€ì¦
          [[ "${TOP}" =~ ^[0-9]+$ ]] || { echo "top_countëŠ” ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤"; exit 1; }
          [[ "${SUB}" =~ ^[0-9]+$ ]] || { echo "sub_countëŠ” ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤"; exit 1; }

          # ì•ˆì „ ê°€ë“œ(ë„ˆë¬´ í° ê°’ ë°©ì§€): í•„ìš” ì‹œ ìƒí–¥ ì¡°ì •
          MAX_TOP=20000
          if (( TOP > MAX_TOP )); then
            echo "top_count=${TOP} ê°€ë“œ ì´ˆê³¼(MAX_TOP=${MAX_TOP}). ê°’ì„ ë‚®ì¶°ì£¼ì„¸ìš”."
            exit 1
          fi

          # ê²½ë¡œ ì •ê·œí™” ë° ìƒì„±
          SAFE_ROOT="${ROOT_DIR#./}"
          [[ -n "${SAFE_ROOT}" ]] || { echo "root_dirê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."; exit 1; }
          mkdir -p "${SAFE_ROOT}"

      - name: Create mass directories
        shell: bash
        run: |
          set -Eeuo pipefail
          ROOT="${ROOT_DIR#./}"

          # 001, 002 í¬ë§·ì„ ìœ„í•œ í­ ê³„ì‚°
          pad() { printf "%0${1}d" "${2}"; }

          width_top=${#TOP}
          (( width_top < 3 )) && width_top=3
          width_sub=${#SUB}
          (( width_sub < 2 )) && width_sub=2

          for i in $(seq 1 "${TOP}"); do
            idx_top=$(pad "${width_top}" "${i}")
            D="${ROOT}/${PREF}${idx_top}"
            mkdir -p "${D}"
            if [[ "${ADD_FILES}" == "true" ]]; then
              [[ -f "${D}/.keep" ]] || printf "placeholder for %s\n" "${D}" > "${D}/.keep"
              [[ -f "${D}/README.md" ]] || printf "# %s\n\nAuto-generated directory.\n" "$(basename "${D}")" > "${D}/README.md"
            fi

            if (( SUB > 0 )); then
              for j in $(seq 1 "${SUB}"); do
                idx_sub=$(pad "${width_sub}" "${j}")
                SD="${D}/${SUBP}${idx_sub}"
                mkdir -p "${SD}"
                if [[ "${ADD_FILES}" == "true" ]]; then
                  [[ -f "${SD}/.keep" ]] || printf "placeholder for %s\n" "${SD}" > "${SD}/.keep"
                fi
              done
            fi
          done

          # íŠ¸ë¦¬ ëª©ë¡ ì €ì¥(gnu tree ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ find ì‚¬ìš©)
          mkdir -p .github/mass-dir-report
          { 
            echo "# Directory Listing"
            echo
            echo "- Root: ${ROOT}"
            echo "- Generated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo
            echo '```'
            find "${ROOT}" -type d | sort
            echo '```'
          } > .github/mass-dir-report/DIRECTORY_TREE.md

          find "${ROOT}" -mindepth 1 -maxdepth 1 -type d | sort > .github/mass-dir-report/top_dirs.txt
          echo "OK"

      - name: Commit & Push (optional)
        if: ${{ inputs.commit_changes == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${ROOT_DIR}" .github/mass-dir-report || true
          if ! git diff --cached --quiet; then
            git commit -m "${{ inputs.commit_message }}"
            git push
          else
            echo "ì»¤ë°‹í•  ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Upload artifact (listing & report)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: |
            .github/mass-dir-report/DIRECTORY_TREE.md
            .github/mass-dir-report/top_dirs.txt
          if-no-files-found: error
