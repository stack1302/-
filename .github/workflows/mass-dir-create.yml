name: "ğŸ—‚ï¸ Mass Dir + ğŸ“€ ISO Builder"

on:
  workflow_dispatch:
    inputs:
      # â”€â”€[1] ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± ì˜µì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      do_generate_dirs:
        description: "ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± ìˆ˜í–‰ ì—¬ë¶€ (true/false)"
        required: true
        default: "false"
      root_dir:
        description: "ìƒì„± ê¸°ì¤€ ê²½ë¡œ(ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ ê¸°ì¤€)"
        required: true
        default: ".github/echo_mass"
      top_count:
        description: "ìµœìƒìœ„ ë””ë ‰í† ë¦¬ ê°œìˆ˜"
        required: true
        default: "1000"
      sub_count:
        description: "ê° ìµœìƒìœ„ ë””ë ‰í† ë¦¬ ì•„ë˜ í•˜ìœ„ ë””ë ‰í† ë¦¬ ê°œìˆ˜ (0=ì—†ìŒ)"
        required: true
        default: "5"
      prefix:
        description: "ë””ë ‰í† ë¦¬ ì ‘ë‘ì–´"
        required: true
        default: "dir-"
      sub_prefix:
        description: "í•˜ìœ„ ë””ë ‰í† ë¦¬ ì ‘ë‘ì–´"
        required: true
        default: "sub-"
      add_placeholder_files:
        description: ".keep/README.md ë“± í”Œë ˆì´ìŠ¤í™€ë” íŒŒì¼ ìƒì„± ì—¬ë¶€ (true/false)"
        required: true
        default: "true"
      commit_changes:
        description: "ìƒì„± ê²°ê³¼ ì»¤ë°‹/í‘¸ì‹œ (true/false)"
        required: true
        default: "false"
      commit_message:
        description: "ì»¤ë°‹ ë©”ì‹œì§€"
        required: false
        default: "chore(mass-dir): add generated directories"

      # â”€â”€[2] ISO ë¹Œë“œ ì˜µì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      iso_source_dir:
        description: "ISOë¡œ ë¬¶ì„ ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ (ê¸°ë³¸: .github)"
        required: true
        default: ".github"
      iso_output_name:
        description: "ì¶œë ¥ ISO íŒŒì¼ëª…(í™•ì¥ì .iso ìë™ ë¶€ì—¬ ì•ŠìŒ)"
        required: true
        default: "github-dir"
      iso_label:
        description: "ISO ë³¼ë¥¨ ë¼ë²¨(ìµœëŒ€ 32ì ê¶Œì¥)"
        required: true
        default: "GITHUB_DIR"
      enable_rockridge:
        description: "Rock Ridge(-R) ì‚¬ìš© (ê¸´ íŒŒì¼ëª…/ê¶Œí•œ ë³´ì¡´)"
        required: true
        default: "true"
      enable_joliet:
        description: "Joliet(-J) ì‚¬ìš© (Windows í˜¸í™˜ ê¸´ íŒŒì¼ëª…)"
        required: true
        default: "true"

permissions:
  contents: write  # commit_changes=trueì¼ ë•Œ í•„ìš”. ì•„ë‹ˆë©´ ì‚¬ìš© ì•ˆ ë¨.

concurrency:
  group: mass-dir-iso-${{ github.ref }}
  cancel-in-progress: false

jobs:
  generate:
    name: "Generate Mass Directories (optional)"
    runs-on: ubuntu-latest
    if: ${{ inputs.do_generate_dirs == 'true' }}
    env:
      ROOT_DIR: ${{ inputs.root_dir }}
      TOP: ${{ inputs.top_count }}
      SUB: ${{ inputs.sub_count }}
      PREF: ${{ inputs.prefix }}
      SUBP: ${{ inputs.sub_prefix }}
      ADD_FILES: ${{ inputs.add_placeholder_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate inputs & safety guard
        shell: bash
        run: |
          set -Eeuo pipefail
          [[ "${TOP}" =~ ^[0-9]+$ ]] || { echo "top_countëŠ” ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤"; exit 1; }
          [[ "${SUB}" =~ ^[0-9]+$ ]] || { echo "sub_countëŠ” ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤"; exit 1; }
          MAX_TOP=20000
          if (( TOP > MAX_TOP )); then
            echo "top_count=${TOP} > MAX_TOP=${MAX_TOP} (ê°€ë“œ ì´ˆê³¼). ê°’ì„ ë‚®ì¶°ì£¼ì„¸ìš”."; exit 1
          fi
          SAFE_ROOT="${ROOT_DIR#./}"
          [[ -n "${SAFE_ROOT}" ]] || { echo "root_dirê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."; exit 1; }
          mkdir -p "${SAFE_ROOT}"

      - name: Create mass directories
        shell: bash
        run: |
          set -Eeuo pipefail
          ROOT="${ROOT_DIR#./}"

          pad() { printf "%0${1}d" "${2}"; }
          width_top=${#TOP}; (( width_top < 3 )) && width_top=3
          width_sub=${#SUB}; (( width_sub < 2 )) && width_sub=2

          for i in $(seq 1 "${TOP}"); do
            idx_top=$(pad "${width_top}" "${i}")
            D="${ROOT}/${PREF}${idx_top}"
            mkdir -p "${D}"
            if [[ "${ADD_FILES}" == "true" ]]; then
              [[ -f "${D}/.keep" ]] || printf "placeholder for %s\n" "${D}" > "${D}/.keep"
              [[ -f "${D}/README.md" ]] || printf "# %s\n\nAuto-generated directory.\n" "$(basename "${D}")" > "${D}/README.md"
            fi
            if (( SUB > 0 )); then
              for j in $(seq 1 "${SUB}"); do
                idx_sub=$(pad "${width_sub}" "${j}")
                SD="${D}/${SUBP}${idx_sub}"
                mkdir -p "${SD}"
                if [[ "${ADD_FILES}" == "true" ]]; then
                  [[ -f "${SD}/.keep" ]] || printf "placeholder for %s\n" "${SD}" > "${SD}/.keep"
                fi
              done
            fi
          done

          mkdir -p .github/mass-dir-report
          {
            echo "# Directory Listing"
            echo
            echo "- Root: ${ROOT}"
            echo "- Generated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo
            echo '```'
            find "${ROOT}" -type d | sort
            echo '```'
          } > .github/mass-dir-report/DIRECTORY_TREE.md

          find "${ROOT}" -mindepth 1 -maxdepth 1 -type d | sort > .github/mass-dir-report/top_dirs.txt
          echo "OK"

      - name: Commit & Push (optional)
        if: ${{ inputs.commit_changes == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${ROOT_DIR}" .github/mass-dir-report || true
          if ! git diff --cached --quiet; then
            git commit -m "${{ inputs.commit_message }}"
            git push
          else
            echo "ì»¤ë°‹í•  ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Upload artifact (listing & report)
        uses: actions/upload-artifact@v4
        with:
          name: mass-dir-listing
          path: |
            .github/mass-dir-report/DIRECTORY_TREE.md
            .github/mass-dir-report/top_dirs.txt
          if-no-files-found: error

  iso:
    name: "Build ISO from .github (or specified dir)"
    runs-on: ubuntu-latest
    needs: [generate]
    if: ${{ always() }}  # generateê°€ ìƒëµë˜ë”ë¼ë„ ISOëŠ” ë‹¨ë… ì‹¤í–‰ ê°€ëŠ¥
    env:
      SRC_DIR: ${{ inputs.iso_source_dir }}
      ISO_NAME: ${{ inputs.iso_output_name }}
      ISO_LABEL: ${{ inputs.iso_label }}
      ROCK: ${{ inputs.enable_rockridge }}
      JOLIET: ${{ inputs.enable_joliet }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate source dir & prepare staging
        shell: bash
        run: |
          set -Eeuo pipefail
          SRC="${SRC_DIR#./}"
          [[ -d "${SRC}" ]] || { echo "ì†ŒìŠ¤ ë””ë ‰í† ë¦¬(${SRC_DIR})ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."; exit 1; }
          mkdir -p iso_build/staging
          # ì†ŒìŠ¤ ë™ê²°(ê¶Œì¥): .gitignore ë¬´ì‹œí•˜ê³  ì „ì²´ ë³µì‚¬
          rsync -a --delete "${SRC}/" "iso_build/staging/${SRC}/"
          # ëª©ë¡/ë©”íƒ€ ìƒì„±
          mkdir -p iso_build/meta
          find "iso_build/staging/${SRC}" -mindepth 1 -maxdepth 1 -type d | sort > iso_build/meta/top_dirs.txt || true
          find "iso_build/staging/${SRC}" -type f | sort > iso_build/meta/files.txt || true

      - name: Install ISO tools (xorriso/genisoimage)
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y xorriso genisoimage

      - name: Build ISO
        shell: bash
        run: |
          set -Eeuo pipefail
          OUT="iso_build/${ISO_NAME}.iso"
          LABEL="${ISO_LABEL}"

          RR_FLAG=""
          J_FLAG=""
          [[ "${ROCK}" == "true" ]]  && RR_FLAG="-R"
          [[ "${JOLIET}" == "true" ]] && J_FLAG="-J"

          # xorrisoë¥¼ mkisofs í˜¸í™˜ ëª¨ë“œë¡œ ì‚¬ìš© (ê¶Œì¥)
          xorriso -as mkisofs \
            ${RR_FLAG} ${J_FLAG} \
            -V "${LABEL}" \
            -input-charset utf-8 \
            -o "${OUT}" \
            iso_build/staging

          # ì‚°ì¶œë¬¼ ê²€ì¦ & ì²´í¬ì„¬
          test -s "${OUT}"
          sha256sum "${OUT}" > "${OUT}.sha256"
          md5sum    "${OUT}" > "${OUT}.md5"

          # ISO ë‚´ìš© ì¸ë±ìŠ¤ (íŒŒì¼ ëª©ë¡)
          isoinfo -i "${OUT}" -f > "iso_build/${ISO_NAME}.filelist.txt" || true

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.iso_output_name }}-iso
          path: |
            iso_build/${{ inputs.iso_output_name }}.iso
            iso_build/${{ inputs.iso_output_name }}.sha256
            iso_build/${{ inputs.iso_output_name }}.md5
            iso_build/${{ inputs.iso_output_name }}.filelist.txt
          if-no-files-found: error
